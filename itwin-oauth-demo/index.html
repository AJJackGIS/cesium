<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auth!</title>
  </head>
  <body>
    <script type="module">
      // based on https://gist.github.com/gauravtiwari/2ae9f44aee281c759fe5a66d5c2721a2

      console.log(window.location);

      const code = new URL(window.location).searchParams.get("code");
      console.log("code", code);

      const response = await fetch(`/token?code=${code}`);
      const result = await response.json();
      const token = result.token;

      if (!code) {
        window.postMessage({ error: "Login failed" });
      } else {
        // this will need the sandcastle page url. The example uses `window.opener.location` but
        // cross origin from inside the iframe prevents this
        window.opener.postMessage(
          { auth: { code: token } },
          "http://localhost:8080",
        );
      }
      console.log("message posted");
    </script>
  </body>
</html>
