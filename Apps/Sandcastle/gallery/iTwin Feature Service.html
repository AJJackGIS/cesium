<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <meta
      name="description"
      content="Use Viewer to start building new applications or easily embed Cesium into existing applications."
    />
    <meta name="cesium-sandcastle-labels" content="Beginner, Showcases" />
    <title>iTwin Feature Service</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script type="module" src="../load-cesium-es6.js"></script>
  </head>
  <body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
    <style>
      @import url(../templates/bucket.css);
    </style>
    <div id="cesiumContainer" class="fullSize"></div>
    <div id="loadingOverlay"><h1>Loading...</h1></div>
    <div id="toolbar">
      <div id="layers"></div>
    </div>
    <script id="cesium_sandcastle_script">
      window.startup = async function (Cesium) {
        "use strict";
        //Sandcastle_Begin
        const serviceResponse = await fetch("https://api.cesium.com/itwin/token");
        const { access_token: token } = await serviceResponse.json();

        Cesium.ITwinPlatform.defaultAccessToken = token;

        const iTwinId = "535a24a3-9b29-4e23-bb5d-9cedb524c743";

        const viewer = new Cesium.Viewer("cesiumContainer");

        const featureServiceBaseUrl = "https://featureservice-eus.bentley.com";
        const proxyUrl = "http://localhost:3000/proxy";

        const points = await Cesium.ITwinData.createDataSourceForRealityDataId(
          iTwinId,
          "60976bd9-3176-4017-974a-4fcea76346db",
        );
        const lines = await Cesium.ITwinData.createDataSourceForRealityDataId(
          iTwinId,
          "5af22b93-cf7e-4879-9305-4c6bdda7987f",
        );
        const areas = await Cesium.ITwinData.createDataSourceForRealityDataId(
          iTwinId,
          "ebec69b5-0b5f-49d8-9081-e29bcd517f6b",
        );
        viewer.dataSources.add(points);
        viewer.dataSources.add(lines);
        viewer.dataSources.add(areas);

        // Create tileset of the reality data mesh
        // TODO: swap this out with a different mesh
        const realityMeshId = "85897090-3bcc-470b-bec7-20bb639cc1b9";
        const realityMesh = await Cesium.ITwinData.createTilesetForRealityDataId(
          iTwinId,
          realityMeshId,
        );
        viewer.scene.primitives.add(realityMesh);

        Sandcastle.addToolbarButton(
          "Toggle Points",
          () => (points.show = !points.show),
          "layers",
        );
        Sandcastle.addToolbarButton(
          "Toggle Lines",
          () => (lines.show = !lines.show),
          "layers",
        );
        Sandcastle.addToolbarButton(
          "Toggle Areas",
          () => (areas.show = !areas.show),
          "layers",
        );
        Sandcastle.addToolbarButton(
          "Toggle Reality Mesh",
          () => (realityMesh.show = !realityMesh.show),
          "layers",
        );

        Sandcastle.addToolbarButton("Zoom to Lines", () => {
          lines.show = true;
          viewer.zoomTo(lines);
        });
        Sandcastle.addToolbarButton("Zoom to Reality Mesh", () => {
          realityMesh.show = true;
          viewer.zoomTo(realityMesh);
        });

        const birdsEyeView = {
          destination: new Cesium.Cartesian3(
            -1525452.5685833949,
            6191771.429542403,
            148747.35086195532,
          ),
          orientation: new Cesium.HeadingPitchRoll(
            3.552713678800501e-15,
            -0.7854791130671286,
            6.283185307179583,
          ),
          duration: 0,
          easingFunction: Cesium.EasingFunction.LINEAR_NONE,
        };
        viewer.scene.camera.flyTo(birdsEyeView);
        //Sandcastle_End
        Sandcastle.finishedLoading();
      };
      if (typeof Cesium !== "undefined") {
        window.startupCalled = true;
        window.startup(Cesium).catch((error) => {
          "use strict";
          console.error(error);
        });
      }
    </script>
  </body>
</html>
